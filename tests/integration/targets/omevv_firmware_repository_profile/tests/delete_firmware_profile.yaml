# Dell OpenManage Ansible modules
# Copyright (C) 2024 Dell Inc. or its subsidiaries. All Rights Reserved.

# GNU General Public License v3.0+ (see COPYING or
# https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Test that we have an OMEVV host, OMEVV username and OMEVV password
  ansible.builtin.fail:
    msg: 'Please define the following variables: hostname, vcenter_uuid,
     vcenter_username and vcenter_password.'
  when: 'hostname is not defined or vcenter_uuid is not defined or vcenter_username
   is not defined or vcenter_password is nor defined'

- block:
    - name: Pre-requisite - Create a profile to be deleted
      dellemc.openmanage.omevv_firmware_repository_profile:
        hostname: "{{ hostname }}"
        vcenter_uuid: "{{ vcenter_uuid }}"
        vcenter_username: "{{ vcenter_username }}"
        vcenter_password: "{{ vcenter_password }}"
        state: "present"
        protocol_type: "CIFS"
        share_username: "{{ cifs_share_user }}"
        share_password: "{{ cifs_share_password }}"
        catalog_name: "{{ cifs_share_name |  regex_replace('\\', '\') }}"
        repository_profile_name: "temp_profile"
      register: create_result
      no_log: true
    
    - name: Verify task status - Create profile
      ansible.builtin.assert:
        that:
          - create_result.changed
          - create_result.msg == "Successfully created the OMEVV firmware repository profile."

    - name: Delete the profile (Check mode - Changes expected)
      dellemc.openmanage.omevv_firmware_repository_profile: &delete_profile
        hostname: "{{ hostname }}"
        vcenter_uuid: "{{ vcenter_uuid }}"
        vcenter_username: "{{ vcenter_username }}"
        vcenter_password: "{{ vcenter_password }}"
        state: "absent"
        repository_profile_name: "temp_profile"
      register: cm_delete_result
      check_mode: true
    
    - name: Verify task status - Delete profile (Check mode)
      ansible.builtin.assert:
        that:
          - cm_delete_result.changed
          - cm_delete_result.msg == "Changes found to be applied."

    - name: Delete the profile (Diff and check modes - Changes expected)
      dellemc.openmanage.omevv_firmware_repository_profile:
        <<: *delete_profile
      register: cm_diff_delete_result
      check_mode: true
      diff: true
    
    - name: Verify task status - Delete profile (Check and Diff modes)
      ansible.builtin.assert:
        that:
          - cm_diff_delete_result.changed
          # - cm_diff_delete_result.msg == "Changes found to be applied."

    - name: Delete the profile (Normal Mode)
      dellemc.openmanage.omevv_firmware_repository_profile:
        <<: *delete_profile
      register: delete_result
    
    - name: Verify task status - Delete profile (Normal Mode)
      ansible.builtin.assert:
        that:
          - delete_result.changed
          - delete_result.msg == "Successfully deleted the OMEVV firmware repository profile."

    - name: Delete a profile (Idempotence)
      dellemc.openmanage.omevv_firmware_repository_profile:
        <<: *delete_profile
      register: idempotence_result_delete
      ignore_errors: true

    - name: Set expected message for assertion
      ansible.builtin.set_fact:
        expected_msg: "Unable to delete the profile temp_profile because the
         profile name is invalid. Enter a valid profile name and
         retry the operation."

    - name: Verify task status - Delete a profile (Idempotence)
      ansible.builtin.assert:
        that:
          - not idempotence_result_delete.changed
          - idempotence_result_delete.msg == expected_msg