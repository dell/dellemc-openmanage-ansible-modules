---
# This is an example playbook to execute Ansible tests.

- name: Verify
  hosts: all
  gather_facts: false
  vars:
    local_path: "{{ lookup('env', 'local_path') }}"
    local_filename: "{{ lookup('env', 'local_filename') }}"
    nfs_filename: "{{ lookup('env', 'nfs_filename') }}"
    cifs_filename: "{{ lookup('env', 'cifs_filename') }}"
    https_filename: "{{ lookup('env', 'https_filename') }}"
    http_filename: "{{ lookup('env', 'http_filename') }}"
    nfs_mount_path: "{{ lookup('env', 'nfs_mount_path') }}"
    cifs_mount_path: "{{ lookup('env', 'cifs_mount_path') }}"

    nfs_url: "{{ lookup('env', 'nfs_url') }}"
    cifs_url: "{{ lookup('env', 'cifs_url') }}"
    cifs_username: "{{ lookup('env', 'cifs_username') }}"
    cifs_password: "{{ lookup('env', 'cifs_password') }}"

    https_url: "{{ lookup('env', 'https_url') }}"
    https_username: "{{ lookup('env', 'https_username') }}"
    https_password: "{{ lookup('env', 'https_password') }}"

    http_url: "{{ lookup('env', 'http_url') }}"
    http_username: "{{ lookup('env', 'http_username') }}"
    http_password: "{{ lookup('env', 'http_password') }}"
  tasks:
    - name: Checking exported file exists in Local path
      ansible.builtin.stat:
        path: "{{ local_path }}/{{ local_filename }}"
      delegate_to: localhost
      register: local_file

    - name: Create a NFS mount point/directory
      ansible.builtin.file:
        path: "{{ nfs_mount_path }}"
        state: directory
        mode: "0755"
      delegate_to: localhost

    - name: Create a CIFS mount point/directory
      ansible.builtin.file:
        path: "{{ cifs_mount_path }}"
        state: directory
        mode: "0755"
      delegate_to: localhost

    - name: Mounting NFS volume to localhost
      ansible.builtin.command:  # noqa: command-instead-of-module
        cmd: "mount -t nfs {{ nfs_url }} {{ nfs_mount_path }}"
      delegate_to: localhost
      register: nfs_mount
      changed_when: nfs_mount.rc == 0

    - name: Checking file exists in NFS mount localhost
      ansible.builtin.stat:
        path: "{{ nfs_mount_path }}/{{ nfs_filename }}"
      delegate_to: localhost
      register: nfs_file

    - name: Mounting CIFS volume to localhost
      ansible.builtin.command:  # noqa: command-instead-of-module
        cmd: "mount -t cifs '{{ cifs_url }}' {{ cifs_mount_path }}
         -o username={{ cifs_username }},password={{ cifs_password }}"
      delegate_to: localhost
      register: cifs_mount
      changed_when: cifs_mount.rc == 0

    - name: Checking file exists in CIFS mount localhost
      ansible.builtin.stat:
        path: "{{ cifs_mount_path }}/{{ cifs_filename }}"
      delegate_to: localhost
      register: cifs_file

    - name: Downloading HTTP file to localhost
      ansible.builtin.uri:
        url: "{{ http_url }}/{{ http_filename }}"
        dest: "/tmp/"
        force_basic_auth: true
        validate_certs: false
        url_username: "{{ http_username }}"
        url_password: "{{ http_password }}"
        mode: '0755'
        use_proxy: false
      delegate_to: localhost
      register: http_file_download
      changed_when: false

    - name: Checking file exists in current location
      ansible.builtin.stat:
        path: "/tmp/{{ http_filename }}"
      delegate_to: localhost
      register: http_file

    - name: Downloading HTTPS file to localhost
      ansible.builtin.uri:
        url: "{{ https_url }}/{{ https_filename }}"
        dest: "/tmp/"
        force_basic_auth: true
        validate_certs: false
        url_username: "{{ https_username }}"
        url_password: "{{ https_password }}"
        use_proxy: false
        mode: '0755'
      delegate_to: localhost
      register: https_file_download
      changed_when: false

    - name: Checking file exists in current location
      ansible.builtin.stat:
        path: "/tmp/{{ https_filename }}"
      delegate_to: localhost
      register: https_file

    - name: Verifying file exists
      ansible.builtin.assert:
        that:
          - local_file.stat.exists
          - nfs_file.stat.exists
          - cifs_file.stat.exists
          - http_file.stat.exists
          - https_file.stat.exists
