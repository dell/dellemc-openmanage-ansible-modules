---
- hosts: ome
  vars:
    retries_count: 50
    polling_interval: 5 # in seconds
  connection: local
  name: OME - Complete network settings with details tracking
  gather_facts: false

  tasks:
    - name: Complete network settings
      dellemc.openmanage.ome_application_network_address:
        hostname: "{{ hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"
        ca_path: "/path/to/ca_cert.pem"
        ipv4_configuration:
          enable: true
          enable_dhcp: false
          static_ip_address: 192.168.0.2
          static_subnet_mask: 255.255.254.0
          static_gateway: 192.168.0.3
          use_dhcp_for_dns_server_names: false
          static_preferred_dns_server: 192.168.0.4
          static_alternate_dns_server: 192.168.0.5
        ipv6_configuration:
          enable: true
          enable_auto_configuration: true
          static_ip_address: 2626:f2f2:f081:9:1c1c:f1f1:4747:1
          static_prefix_length: 10
          static_gateway: 2626:f2f2:f081:9:1c1c:f1f1:4747:2
          use_dhcp_for_dns_server_names: true
          static_preferred_dns_server: 2626:f2f2:f081:9:1c1c:f1f1:4747:3
          static_alternate_dns_server: 2626:f2f2:f081:9:1c1c:f1f1:4747:4
        dns_configuration:
          register_with_dns: true
          use_dhcp_for_dns_domain_name: false
          dns_name: "MX-SVCTAG"
          dns_domain_name: "localdomainname"
        reboot_delay: 1
      register: facts_result

    # To end play when no job_info
    - name: End the play when no job_info # noqa: no-handler
      ansible.builtin.meta: end_play
      when:
        - not facts_result.changed
        - "'job_info' not in facts_result"

    - name: Get job details using job id from network address config task.
      dellemc.openmanage.ome_job_info:
        hostname: "{{ hostname }}"
        username: "{{ username }}"
        password: "{{ password }}"
        ca_path: "/path/to/ca_cert.pem"
        job_id: "{{ facts_result.job_info.Id }}"
      register: job_result
      failed_when: job_result.job_info.LastRunStatus.Name == 'Failed'
      changed_when: job_result.job_info.LastRunStatus.Name == 'Completed'
      until: job_result.job_info.LastRunStatus.Name == 'Completed' or job_result.job_info.LastRunStatus.Name == 'Failed'
      retries: "{{ retries_count }}"
      delay: "{{ polling_interval }}"
