---
- name: Converge
  hosts: all
  gather_facts: false
  tasks:
    - name: Set controller encryption LKM
             (Check mode - Changes expected)
      ansible.builtin.import_role:
        name: idrac_storage_controller
      vars:
        hostname: "{{ lookup('env', 'IDRAC_IP') }}"
        username: "{{ lookup('env', 'IDRAC_USER') }}"
        password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
        validate_certs: false
        job_wait: true
        job_wait_timeout: 1200
        controller_id: "{{ controller_name }}"
        set_controller_key: true
        key: "your_Key@123"
        key_id: "your_Keyid@123"
      register: idrac_storage_controller_set_lkm_encryption

    - name: Verify task status -Set controller encryption LKM
       (Check mode - Changes expected)
      ansible.builtin.assert:
        that:
          - set_controller_key_out.changed
          - set_controller_key_out.msg == "Changes found to be applied."
      when: ansible_check_mode

    - name: Waiting for iDRAC to be in ready state
      ignore_errors: true
      register: pd_state_out_lc
      ansible.builtin.include_tasks:
        file: ../__lc_status.yaml
      when: set_controller_key_out.msg == "Successfully performed the
             'SetControllerKey' operation."

    - name: Get data
      ansible.builtin.include_tasks: ../__get_data.yaml
      vars:
        url: "{{ job_url }}"
      when: not ansible_check_mode and set_controller_key_out.status is defined

    - name: Verify task status - Set controller encryption LKM (Normal mode)
      ansible.builtin.assert:
        that:
          - set_controller_key_out.changed
          - set_controller_key_out.msg == "Successfully performed the
           'SetControllerKey' operation."
          - idrac_storage_controller_fetched_data.json.Oem.Dell.
            DellStorageController.EncryptionMode == "LocalKeyManagement"
          - idrac_storage_controller_fetched_data.json.Oem.Dell.
            DellStorageController.KeyID == "your_Keyid@123"
      when: not ansible_check_mode and set_controller_key_out.status is defined

    - name: Verify task status - Set controller encryption LKM
       (Idempotency mode)
      ansible.builtin.assert:
        that:
          - not set_controller_key_out.changed
          - set_controller_key_out.msg == "No changes found
           to be applied."
      when: not ansible_check_mode and set_controller_key_out.status
             is not defined
