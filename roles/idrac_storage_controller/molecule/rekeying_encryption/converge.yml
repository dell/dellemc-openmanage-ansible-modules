---
- name: Converge
  hosts: all
  gather_facts: false
  tasks:
    - name: Set rekeying of controller encryption key
           (Check mode - Changes expected)
      ansible.builtin.import_role:
        name: idrac_storage_controller
      vars:
        hostname: "{{ lookup('env', 'IDRAC_IP') }}"
        username: "{{ lookup('env', 'IDRAC_USER') }}"
        password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
        validate_certs: false
        job_wait: true
        job_wait_timeout: 1200
        controller_id: "{{ controller_name }}"
        mode: "LKM"
        key: "new_Key@123"
        old_key: "your_Key@123"
        key_id: "your_Keyid@123"
        rekey: true
      register: idrac_storage_controller_rekey_controller_encryption

    - name: Verify task status - Set rekeying of controller encryption key
       (Check mode - Changes expected)
      ansible.builtin.assert:
        that:
          - storage_controller_rekey.changed
          - storage_controller_rekey.msg == "Changes found to be applied."
      when: ansible_check_mode

    - name: Waiting for iDRAC to be in ready state
      ansible.builtin.wait_for:
        timeout: 120
      when: storage_controller_rekey.msg == "Successfully performed the
       'ReKey' operation."    # noqa: no-handler

    - name: Waiting for iDRAC to be in ready state
      ignore_errors: true
      register: idrac_storage_controller_pd_state_out_lc
      ansible.builtin.include_tasks:
        file: ../__lc_status.yaml
      when: storage_controller_rekey.msg == "Successfully performed the
       'ReKey' operation."

    - name: Get data
      ansible.builtin.include_tasks: ../__get_data.yaml
      vars:
        url: "{{ job_url }}"
      when: not ansible_check_mode and storage_controller_rekey.status
             is defined

    - name: Verify task status - Set rekeying of controller encryption
             key (Normal mode)
      ansible.builtin.assert:
        that:
          - storage_controller_rekey.changed
          - storage_controller_rekey.msg == "Successfully performed the
            'ReKey' operation."
          - idrac_storage_controller_fetched_data.json.Oem.Dell.
            DellStorageController.EncryptionMode == "LocalKeyManagement"
          - idrac_storage_controller_fetched_data.json.Oem.Dell.
            DellStorageController.KeyID == "your_Keyid@123"
      when: not ansible_check_mode and storage_controller_rekey.status
             is defined
