---
- name: Converge
  hosts: all
  gather_facts: false
  tasks:
    - name: Block for disk status change to online
      block:
        - name: Create a list of dictionaries of dictionaries
          ansible.builtin.set_fact:
            my_list:
              id: "{{ physicaldisks[0] }}"
              status: online

        - name: Validate the disk status change to online
          ansible.builtin.import_role:
            name: idrac_storage_controller
          vars:
            hostname: "{{ lookup('env', 'IDRAC_IP') }}"
            username: "{{ lookup('env', 'IDRAC_USER') }}"
            password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
            validate_certs: false
            job_wait: true
            job_wait_timeout: 1200
            controller_id: "{{ controller_name }}"
            disks: "{{ my_list }}"

        - name: Verifying disk status change to online in check mode
          ansible.builtin.assert:
            that:
              - pd_state_out.msg == "Changes found to be applied."
              - pd_state_out.changed
          when: ansible_check_mode

        - name: Verifying disk status change to online in normal mode
          ansible.builtin.assert:
            that:
              - pd_state_out.msg == "Successfully performed the
               'ChangePDStateToOnline' operation."
              - pd_state_out.changed
          when: not ansible_check_mode and pd_state_out.changed

        - name: Verifying disk status change to online in idempotence mode
          ansible.builtin.assert:
            that:
              - pd_state_out.msg == "No changes found to be applied."
              - not pd_state_out.changed
          when: not ansible_check_mode and not pd_state_out.changed
