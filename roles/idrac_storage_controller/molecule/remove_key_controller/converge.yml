---
- name: Converge
  hosts: all
  gather_facts: false
  tasks:
    - name: Remove controller encryption key
           (Check mode - Changes expected)
      ansible.builtin.import_role:
        name: idrac_storage_controller
      vars:
        hostname: "{{ lookup('env', 'IDRAC_IP') }}"
        username: "{{ lookup('env', 'IDRAC_USER') }}"
        password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
        validate_certs: false
        job_wait: true
        job_wait_timeout: 1200
        controller_id: "{{ controller_name }}"
        remove_key: true
      register: idrac_storage_controller_remove_controller_encryption

    - name: Verify task status - Remove controller encryption key
       (Check mode - Changes expected)
      ansible.builtin.assert:
        that:
          - remove_controller_key_out.changed
          - remove_controller_key_out.msg == "Changes found to be applied."
      when: ansible_check_mode

    - name: Waiting for iDRAC to be in ready state
      ansible.builtin.wait_for:
        timeout: 120
      when: remove_controller_key_out.msg == "Successfully performed the
       'RemoveControllerKey' operation."    # noqa: no-handler

    - name: Waiting for iDRAC to be in ready state
      ignore_errors: true
      register: idrac_storage_controller_pd_state_out_lc
      ansible.builtin.include_tasks:
        file: ../__lc_status.yaml
      when: remove_controller_key_out.msg == "Successfully performed the
       'RemoveControllerKey' operation."

    - name: Get data
      ansible.builtin.include_tasks: ../__get_data.yaml
      vars:
        url: "{{ job_url }}"
      when: not ansible_check_mode and remove_controller_key_out.status
            is defined

    - name: Verify task status - Remove controller encryption key
            (Normal mode)
      ansible.builtin.assert:
        that:
          - remove_controller_key_out.changed
          - remove_controller_key_out.msg == "Successfully performed the
            'RemoveControllerKey' operation."
          - idrac_storage_controller_fetched_data.json.Oem.Dell.
            DellStorageController.EncryptionMode == "None"
      when: not ansible_check_mode and remove_controller_key_out.status
             is defined

    - name: Verify task status - Remove controller encryption key
       (Idempotency mode)
      ansible.builtin.assert:
        that:
          - not remove_controller_key_out.changed
          - remove_controller_key_out.msg == "No changes found
           to be applied."
      when: not ansible_check_mode and remove_controller_key_out.status
             is undefined
