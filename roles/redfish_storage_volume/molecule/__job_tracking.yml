---
- name: Performing iDRAC reset and waiting for LC to be ready
  ansible.builtin.include_tasks:
    file: ../__idrac_reset.yml
  when: redfish_storage_volume_reset is defined and redfish_storage_volume_reset

- name: Job tracking
  ansible.builtin.uri:
    url: "https://{{ lookup('env', 'IDRAC_IP') }}/redfish/v1/Managers/iDRAC.Embedded.1/Jobs/{{ redfish_storage_volume_out.task.id }}"
    user: "{{ lookup('env', 'IDRAC_USER') }}"
    password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
    timeout: "{{ https_timeout }}"
    validate_certs: false
    method: "GET"
    status_code: 200, 202
    return_content: true
    force_basic_auth: true
    headers:
      Content-Type: "application/json"
      Accept: "application/json"
  register: job_result
  failed_when: "'json' not in job_result or job_result.json.JobState in ['Failed']"
  until: job_result.json.JobState == 'Completed' or job_result.json.JobState == 'Pending'
  retries: 120
  delay: 10
  check_mode: true
