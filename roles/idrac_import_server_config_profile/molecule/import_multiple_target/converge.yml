---
- name: Converge
  hosts: all
  gather_facts: false
  tasks:

    - name: "Importing SCP from NFS with multiple components"
      ansible.builtin.import_role:
        name: idrac_import_server_config_profile
      vars:
        hostname: "{{ lookup('env', 'HOSTNAME') }}"
        username: "{{ lookup('env', 'USERNAME') }}"
        password: "{{ lookup('env', 'PASSWORD') }}"
        validate_certs: false
        target:
          - 'NIC'
          - 'IDRAC'
        share_parameters:
          share_name: "{{ lookup('env', 'NFS_URL') }}"
          scp_file: "{{ lookup('env', 'nfs_filename') }}"
        shutdown_type: 'Forced'
        end_host_power_state: 'On'
      when: not ansible_check_mode

    - name: Verifying Import SCP from NFS with multiple components in normal mode
      ansible.builtin.assert:
        that:
          - idrac_import_server_config_profile_out.msg ==  "Successfully imported the Server Configuration Profile."
          - idrac_import_server_config_profile_out.scp_status.JobState == "Completed"
          - idrac_import_server_config_profile_out.scp_status.Message == "Successfully imported and applied Server Configuration Profile."
      when: not ansible_check_mode
      tags: molecule-idempotence-notest

    - name: Verifying Import SCP from NFS with multiple components in idempotence mode
      ansible.builtin.assert:
        that:
          - idrac_import_server_config_profile_out.msg ==  "Successfully imported the Server Configuration Profile."
          - idrac_import_server_config_profile_out.scp_status.JobState == "Completed"
          - idrac_import_server_config_profile_out.scp_status.Message == "No changes were applied since the
           current component configuration matched the requested configuration."
      when: not ansible_check_mode and not idrac_import_server_config_profile_out.changed
